# OptiCNN-Fed
# 遗传算法与联邦学习项目

## 项目概述

本项目是一个结合遗传算法的联邦学习框架，用于优化卷积神经网络（CNN）的架构。项目的目标是结合联邦学习的优势（允许分布式模型训练并保持数据隐私）和遗传算法（帮助优化超参数和神经网络架构）。本项目使用 Python 3.7.1、TensorFlow Federated 0.17.0 和 TensorFlow 2.3.4 实现。

### 主要特点

- 多客户端的联邦学习设置。
- 使用遗传算法优化神经网络架构。
- 具有自适应池化和卷积层的 CNN 模型。
- 包括准确率、精确率、召回率和 F1 分数的交叉验证和评估指标。

## 遗传算法细节

本项目中，遗传算法用于优化 CNN 模型的架构。以下是遗传算法的关键步骤：

### 1. 初始化

初始种群是随机生成的，每个个体代表 CNN 的不同架构。每个个体包含以下属性：

- **卷积层数量**：随机在 2 到 5 之间。
- **每层的滤波器数量**：每层随机选择 16 到 64 之间的值。
- **每层的卷积核大小**：选择 3 或 5。
- **激活函数**：`relu` 或 `tanh`。
- **池化大小**：选择 2 或 3。

### 2. 适应度函数

通过在训练数据上训练对应的 CNN 固定次数（例如 10 轮）来评估每个个体的适应度。适应度评估指标是验证集上的准确率。

### 3. 父代选择（锦标赛选择）

遗传算法使用 **5 路锦标赛选择** 来选择交叉的父代。具体来说，从种群中随机选择五个个体，基于适应度选择表现最好的两个个体作为父代。

### 4. 交叉

通过对选定的父代进行 **交叉** 操作生成后代。对于个体的每个属性，选择一个交叉点：

- **滤波器、卷积核大小、池化大小**：通过从父代中选择值到某个交叉点来进行交叉。
- **激活函数**：从父代之一随机选择。
- **层数**：从父代之一选择。

交叉率设定为 **0.8**，意味着生成后代时有 80% 的几率进行交叉。

### 5. 变异

**变异** 操作通过随机改变个体的属性引入种群多样性。变异率设定为 **0.2**。包括层数、滤波器大小、卷积核大小、激活函数和池化大小等属性可能会被修改。

### 6. 进化过程

遗传算法运行 **100 代**，每代包括评估个体的适应度、选择父代、进行交叉和应用变异。表现最好的个体会被保留到下一代，以确保朝向最优架构的收敛。

## CNN 架构

由遗传算法生成的 CNN 模型包含：

- **卷积层**：根据遗传算法输出的不同数量和滤波器大小。
- **池化层**：自适应池化大小（2 或 3），用于减少空间维度。
- **批归一化**：在每次卷积和池化操作后应用，用于稳定训练。
- **全连接层**：在卷积层的输出展开后，使用一个具有 sigmoid 激活函数的全连接层用于二分类。

## 解决错误与挑战

在开发过程中遇到了许多错误并进行了修复：

1. **EagerTensor 捕获错误**：错误 `RuntimeError: Attempting to capture an EagerTensor without building a function` 是由于 TensorFlow 尝试在图上下文中使用 EagerTensor。通过确保所有 TensorFlow 操作都包含在 `tf.function` 装饰器中来强制执行图执行，从而解决了这个问题。

2. **负维度大小错误**：在池化期间遇到的负维度大小相关错误，通过确保池化大小根据当前层的输出大小自适应选择来解决，防止池化操作将维度减少到小于 1。

3. **缺少 CUDA DLL 文件**：在设置过程中，缺少 CUDA DLL 文件（例如 `cudart64_101.dll` 和 `cudnn64_7.dll`）导致运行时错误。通过安装正确版本的 CUDA 和 cuDNN，或者选择仅使用 CPU 运行训练来解决。

## 需求

- **Python**：3.7.1
- **TensorFlow Federated**：0.17.0
- **TensorFlow**：2.3.4
- **CUDA 和 cuDNN**：如果使用 GPU，请确保安装正确的版本。缺少的 DLL 文件可以从 [NVIDIA 网站](https://developer.nvidia.com/cudnn) 下载。
- **仅 CPU 选项**：如果没有 CUDA 和 cuDNN，可通过设置 `CUDA_VISIBLE_DEVICES="-1"` 使用 CPU 运行项目。

## 如何运行项目

1. 安装所需依赖项。
2. 确保 TensorFlow Federated 和 TensorFlow 与您的 Python 版本兼容。
3. 如果使用 GPU，请验证 CUDA 和 cuDNN 是否正确安装。
4. 使用 Python 运行脚本：
   ```sh
   python dnntry1.py
   ```

## 观察结果

遗传算法在优化 CNN 架构方面提供了显著的改进。与传统的全连接网络（FCNN）相比，CNN 在提取空间特征方面的能力使其在网络攻击分类中表现更好。锦标赛选择和变异机制确保了种群的多样性，降低了收敛到局部最优的风险。

本项目展示了将进化技术与联邦学习相结合的有效性，以适应性地找到更好的神经网络架构，从而无需共享原始数据即可在分布式客户端中进行训练。 FYI， 其实叫做dnntry1的脚本用的是cnn，目前还未对dnn的表现进行测试。
